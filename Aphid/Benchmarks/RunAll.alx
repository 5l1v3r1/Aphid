#'Std';
#'Process';
using System.IO;
using System.Text;

var ignore = [
    '581bb73 Updated interop type caching to use hash sets.'
];

var config = 'Release';
var root = Path.Combine(Path.GetDirectoryName(this['$script']), '..', '..') |> Path.GetFullPath;
var testRoot = Path.Combine(root, '..', 'AphidBenchMark') |> Path.GetFullPath;
var csProj = testRoot + '\\Aphid\\Aphid.csproj';
var benchRel = '\\Aphid\\Benchmarks';
var testSrc = root + benchRel;
var testDst = testRoot + benchRel;
var bin = '\\bin\\' + config;
var testBin = testRoot + '\\Aphid' + bin;
var testBin2 = testRoot + '\\Components.Aphid' + bin;
var exe = testBin + '\\Aphid.exe';
var test = exe + ' run2.alx';
var tmpDir = testSrc + '\\temp';
var cd = @Directory.SetCurrentDirectory(testRoot);

var init = @{
    if (Directory.Exists(testRoot)) {
        cd();
        #> 'git fetch --all';        
        #> 'git reset --hard origin/master';
        #> 'git pull';
    } else {
        #> ('git clone https://github.com/John-Leitch/Aphid.git ' + testRoot);
        cd();
    }
    
    #> ('cmd /c mkdir ' + tmpDir);
    #> ('cmd /c del ' + testDst + '\\history.* /q');
};

var run = @{
    var hasExe = @File.Exists(exe);

    [ 'aphid*.exe', 'components*.dll', '*.alx', '*.cache*' ]
        ->@(p) [ testBin, testBin2 ]
            ->@() #> ('cmd /c del ' + $_ + '\\' + p + ' /s /q');

    #> ('c:\\Windows\\Microsoft.NET\\Framework64\\v4.0.30319\\MSBuild.exe ' + 
        csProj + ' ' +
        (((csProj  |> File.ReadAllText) ~= 'Release\\|Default') ? '/p:Platform= ' : '') +
        '/p:Configuration=' + config + ' ' +
        '/verbosity:quiet');
    
    if (hasExe()) {
        #> ('cmd /c copy ' + testSrc + '\\*.alx ' + testDst + ' /y');
        Directory.SetCurrentDirectory(testDst);
        #> test;
    }

    rollBack();
};

var sb = new StringBuilder();

var rollBack = @{
    cd();
    #> ('cmd /c copy ' + testDst + '\\history.* ' + tmpDir + ' /y');
    
    var tries = 0;

    while (true) {
        cd();
        #> 'git reset --hard HEAD~1';

        sb.Clear();
        'git show --name-only --oneline' ~> sb.AppendLine;

        var s = sb.ToString();

        
        if (ignore =? s.StartsWith) {
            print('Ignoring:\r\n~Red~{0}~R~', sb);
        } else if (s.ToLower() ~= '\\.cs[^a-z0-9]') {
            print('C# changes found:\r\n~Green~{0}~R~', sb);
            break;
        } else {
            print('No C# changes found:\r\n~Yellow~{0}~R~', sb);
        }
        
        if (++tries == 100) {
            print('No more CS changes found, exiting');
        }
    }

    #> ('cmd /c copy ' + tmpDir + '\\history.* ' + testDst + ' /y');
};

init();

while (true) {
    run();
}
